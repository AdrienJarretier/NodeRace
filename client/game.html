<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <title>Cars Online</title>
    <link rel="stylesheet" type="text/css" href="/css/style.css">
    <script src="js/cars.js"></script>
    <script src="js/game.js"></script>
    <script src="js/jaws.js"></script>
    <script src="js/jaws-sprite_list.js"></script>
    <script src="js/jaws-tile_map.js"></script>
    <script src="js/manageChat.js"></script>
    <script src="js/tile.js"></script>
    <script src="js/tileset.js"></script>
    <script src="public/constants.js"></script>
</head>

<body>
    <header>
        <h1>NodeRace</h1>
    </header>
    <div id="colonne1">
        <legend>Chat Room</legend>
        <hr>
        <div>
            Message:
            <input type="text" name="user" id="message" placeholder="votre message">
            <input type="submit" value="Submit" id="submit">
            </form>
        </div>
        <div id="oldMessages"></div>
        <div id="listMessage"></div>
        </br>
    </div>
    <div id="centre">
        <form action="/" method="post" id="formulaire">
            <fieldset>
                Login:
                <input type="text" name="user" id="login" autocomplete="on" autofocus>
                </br>
                Car:
                <select id="cars">
                </select>
                </br>
                <script src="js/parseJsonFile.js">


                </script>
                Track:
                <select id="track">
                </select>
                </br>
                Laps
                <input type="range" id="laps" value="3" max="10" min="1" step="1">
                </br>
                <input type="Checkbox" id="host" name="host" value="false">Host
                </br>
                <input type="Checkbox" id="private" name="private" value="false">Private game
                <div id="subMenu">
                    Password:
                    <input type="text" name="user" id="password" autocomplete="on">
                    </br>
                    Minimum opponents
                    <input type="range" id="minCar" value="2" max="8" min="2" step="1">
                    </br>
                    Maximum opponents
                    <input type="range" id="maxCar" value="8" max="8" min="3" step="1">
                    </br>
                </div>
                </br>
                <input type="submit" value="Submit" id="submit">
            </fieldset>
        </form>
        </br>
        <div id="info"></div>
        <canvas id="gameCanvas" width="1000" height="500">
            Your browser is not compatible !
        </canvas>
        </br>
        <div id="speed">
        </div>
        <div id="live_info"></div>
        <div id="debug"> </div>
        <h3>jaws log</h3>
        <div id="jaws-log"></div>
    </div>
    </br>
    <footer>
        A game developed by Adrien Jarretier and Gomez Guillaume.
    </footer>
    <!-- Chargement du jeu -->
    <script>
    username = "";
    trackName = "";
    carName = "";

    var game;
    window.onload = function() {
        jaws.unpack();
        jaws.assets.root = "assets/";

        var arrayTileInfo = [];
        ParseJsonFile.getTileInfo(function(arrayTileInfo) {

            for (var i = 0; i < arrayTileInfo.length; i++) {
                jaws.assets.add(arrayTileInfo[i].url);
            };

        });
        ParseJsonFile.createCarsSelectionMenu("cars");
        ParseJsonFile.createTracksSelectionMenu("track");
    }

    </script>
    <!-- la partie websocket qui permet la communication avec node.js -->
    <script src="/socket.io/socket.io.js"></script>
    <script src="js/jquery-1.11.1.min.js"></script>
    <script>
    var socket = io();
    jaws.constants = new Constants();
    // by default connect to the host that served this page

    var cars = [];

    socket.on(jaws.constants.login, function(loginInfos) {

        cars[loginInfos.id] = loginInfos.carName;

        game.addCar(loginInfos.id, loginInfos.carName);

        //prevenir le jeu qu'un nouveau joueur
        var message = $('#info').html("<p>player " + loginInfos.username + " just connected</p>");

    });

    socket.on(jaws.constants.instanceNotFound, function() {
        alert('no game found');
    });

    socket.on(jaws.constants.id, function(id) {
        username = $('#login').val();
        // window.location += '#gameCanvas';
        if (window.location.search == '') {
            window.location = 'game.html#gameCanvas';
        }

        //on lance le jeu quand on a recuperer l'id de connexion
        game = new Game(socket, id, trackName, cars);
        jaws.start(game);
    });

    socket.on(jaws.constants.infoPart, function(infos) {
        laps = infos.laps;
        nbCarsPlayed = infos.nbComponents;
        trackName = infos.track;
        cars = infos.selectedCarNames;
    });

    // Lorsqu'on envoie le formulaire, on transmet le message et on l'affiche sur la page
    $('#formulaire').submit(function() {
        var log = $('#login').val();
        var passwd = $('#password').val();
        var minCar = $('#minCar').val();
        var maxCar = $('#maxCar').val();
        var isHost = ($('#host').is(":checked"));
        var isPrivate = ($('#private').is(":checked"));
        var lap = $('#laps').val();
        carName = $('#cars').val();
        trackName = $('#track').val();

        var emptyPattern = /[a-z]/i;
        var valid = true;

        if (!emptyPattern.test(log)) {
            alert("Please set the login");
            valid = false;
        }

        if(!emptyPattern.test(carName)) {
            alert("Please select a car")
            valid = false;
        }

        if(valid) {

            var message = {
                car: carName,
                login: log,
                minCar: minCar,
                maxCar: maxCar,
                host: isHost,
                private: isPrivate,
                password: passwd,
                laps: lap,
                track: trackName
            };
            socket.emit(jaws.constants.login, message);
            manageChat(socket);
            console.log(window.location);

        }
        return false; // Permet de bloquer l'envoi "classique" du formulaire
    });

    socket.on(jaws.constants.startGame, function() {
        var demarre = true;
        console.log("The game is starting");
    });

    socket.on(jaws.constants.instanceDisconnection, function(message) {
        alert(message);
    });

    socket.on(jaws.constants.isExist, function() {
        alert('There is already an ongoing game with this password');
    });

    $(window).unload(function() {
        alert("Handler for .unload() called.");
        socket.emit(jaws.constants.disconnection, 'disconnection');
    });

    </script>
</body>

</html>
