<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8" />
        <title>Cars Online</title>
        <link rel="stylesheet" type="text/css" href="/css/style.css">
        <script src="js/jaws.js"></script>
        <script src="js/cars.js"></script>
        <script src="js/game.js"></script>
        <script src="js/tile.js"></script>
        <script src="js/tileset.js"></script>
        <script src="js/jaws-sprite_list.js"></script>
        <script src="js/jaws-tile_map.js"></script>
        <script src="js/manageChat.js"></script>
    </head>
 
    <body>       
        <header>
            <h1>Le super jeu en HTML5 </h1>
        </header>  

        <div id="colonne1">
        <legend>Chat Room</legend>
        <hr>    
            <div>
                
                    Message: <input type="text" name="user" id="message" placeholder="votre message">
                    <input type="submit" value="Submit" id="submit">
                </form>
            </div>

            <div id="oldMessages"></div>

            <div id="listMessage"></div>
        </br>
        </div>


        <div id="centre">
            <form action="/" method="post" id="formulaire">
                <fieldset>
                    Login: <input type="text" name="user" id="login" autocomplete="on" autofocus>
                </br>
                    Voiture: <select>
                                <option value="volvo">Volvo</option>
                                <option value="saab">Saab</option>
                                <option value="mercedes">Mercedes</option>
                                <option value="audi">Audi</option>
                            </select>
                </br>
                    Circuit: <select>
                                <option value="id56">track1</option>
                                <option value="id68">track2</option>
                                <option value="id24">track3</option>
                                <option value="id32">track4</option>
                            </select>
                </br>
                Nombre de tours <input type="range" id="laps" value="3" max="10" min="1" step="1">   
                </br>
                <input type="Checkbox" id="host" name="host" value="false">Hôte d'une partie
                </br>
                <input type="Checkbox" id="private" name="private" value="false">Partie Privé
                
                <div id="subMenu">
                    Password: <input type="text" name="user" id="password" autocomplete="on">
                    </br>
                    Nombre de participants min <input type="range" id="minCar" value="2" max="8" min="2" step="1">
                    </br>
                    Nombre de participants max <input type="range" id="maxCar" value="8" max="8" min="3" step="1">   
                    </br>
                </div>
                </br>
                    <input type="submit" value="Submit" id="submit">
                </fieldset>
            </form>
            </br>

            <div id="info"></div>

            <canvas id="gameCanvas" width="1000" height="500">
                Votre navigateur n'est pas compatible !
            </canvas>
            </br>
            <div id="speed"></div>
            <div id="live_info"></div>
            <div id="debug"> </div>

            <h3>jaws log</h3>
            <div id="jaws-log"></div>
        </div>

        </br>
        <footer>
            Un jeu developpé par Adrien Jarretier et Gomez Guillaume.
            Designed par Corenthin . ... 
        </footer>


        <!-- Chargement du jeu -->
        <script>
        var game;
            window.onload = function()
            {
                jaws.unpack();
                jaws.assets.root = "assets/";
                jaws.assets.add(["cars/Viper.png", "cars/Cobra.png",
                "cars/Firebird1980.png", "cars/Herbie.png"]);
                jaws.assets.add(["floor.png", "test.png"]);
                jaws.assets.add(["tracks/default.json"]);
            }
        </script>
        

        <!-- la partie websocket qui permet la communication avec node.js -->
        <script src="/socket.io/socket.io.js"></script>
        <script src="js/jquery-1.11.1.min.js"></script>

        <script>
            var xmlhttp = new XMLHttpRequest();

            xmlhttp.open("GET", "config.json", false);
            xmlhttp.send();
            var config = JSON.parse(xmlhttp.responseText);

            var socket = io.connect('http://'+config.address+':'+config.port);

            socket.on('messageServeur', function(position) {
                //prevenir le jeu qu'un nouveau joueur
                var message = $('#info').html("<p>Un nouveau joueur vient de se connecter</p>");

            });

            socket.on('erreur', function(message) {
                alert(message);
            });

            socket.on('id', function(id) {
                var username = $('#login').val();
               // window.location += '#gameCanvas';
                console.log(window.location += '#gameCanvas');
                //on lance le jeu quand on a recuperer l'id de connexion
                game = new Game(socket, id, username);
                jaws.start(game);
            });

            socket.on('infoPart', function(infos) {
                laps = infos.laps;
                nbCarsPlayed = infos.nbComponents;
            });

            // Lorsqu'on envoie le formulaire, on transmet le message et on l'affiche sur la page
            $('#formulaire').submit(function () {
                var log = $('#login').val();
                var passwd = $('#password').val();
                var minCar = $('#minCar').val();
                var maxCar = $('#maxCar').val();
                var isHost = ($('#host').is(":checked"));
                var isPrivate = ($('#private').is(":checked"));
                var lap = $('#laps').val();

                var message = {login:log, minCar:minCar, maxCar:maxCar, host:isHost, private: isPrivate, password: passwd, laps: lap};
                socket.emit('login', message);

                manageChat(socket);
                console.log(window.location);
                return false; // Permet de bloquer l'envoi "classique" du formulaire
            });

            socket.on('depart', function(message) {
                var demarre = true;
            });

            socket.on('deconnexionPartie', function(message) {
                alert(message);
            });

            $( window ).unload(function() {
                alert( "Handler for .unload() called." );
                socket.emit('deconnexion', 'deconnexion');
            });
            
        </script>
    </body>
</html> 
